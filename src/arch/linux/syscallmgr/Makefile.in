#
# This is the Makefile for the sycallmgr-subdirectory of the DOS-emulator
# for Linux.
#

REALTOPDIR=@REALTOPDIR@
TOPDIR=@SRCPATH@
CFLAGS=@CFLAGS@
LDFLAGS=@LDFLAGS@
CC=@CC@
@SET_MAKE@

# The following variables may go into the Makfile in the parent-directory

#CC   = gcc
LD   = @CC@
USRSRCDIR=/usr/src
BINPATH=@BINPATH@

# If INCDIR exists, it was exported from the master Makefile.
ifndef INCDIR
  INCDIR=-I/usr/include/ncurses -I../../../include -I..
endif

# let gcc do extended checking

CFLAGS=-O2 -Wall # -Wmissing-prototypes \
#       -Wstrict-prototypes -ansi -pedantic 

# ANSI isn't possible right now, because some header-file aren't ANSI

CFILES = syscallmgr.c insmod.c load_aout.c load_elf.c testsys.c \
	 testmain.c error.c
HFILES = insmod.h
OFILES = 
KVFILE = ../../../include/kversion.h

# Insert all source- and header-files here.

ALL = $(CFILES) $(HFILES) $(OFILES) README.syscallmgr


# All object-files are included here.

OBJS =

all: $(BINPATH)/modules/syscallmgr.o $(BINPATH)/bin/insmod testsys.o testmain

.c.o:
	$(CC) $(CFLAGS) @XLIBSW@ $(INCDIR) -c $<

$(BINPATH)/modules/syscallmgr.o:    syscallmgr.c ../../../include/syscallmgr.h $(KVFILE)
	$(CC) -m486 -Wall -I$(USRSRCDIR) $(INCDIR) -c -O2 -fomit-frame-pointer -D__KERNEL__ -DLINUX -c syscallmgr.c -o $@

testsys.o:    testsys.c 
	$(CC) -m486 -Wall -I$(USRSRCDIR) $(INCDIR) -c -O2 -fomit-frame-pointer -D__KERNEL__ -DLINUX -c testsys.c -o testsys.o

testmain:	testmain.c
	$(CC) -m486 -Wall $(INCDIR) -O6 testmain.c -o testmain


$(BINPATH)/bin/insmod: insmod.c load_aout.c load_elf.c insmod.h
	$(CC) -m486 -O6 -pipe -fomit-frame-pointer -Wall -DHACKER_TOOL -DWITHIN_DOSEMU $(INCDIR) \
	insmod.c load_aout.c load_elf.c error.c -o $@
	for i in rmmod ksyms; do ln -sf insmod $(BINPATH)/bin/$$i; done


checkin:
	-ci -l $(ALL) Makefile

checkout:
	-co -M -l $(ALL) Makefile

clean:
	rm -f *.o $(BINPATH)/bin/insmod $(BINPATH)/bin/rmmod $(BINPATH)/bin/ksyms testmain *~

realclean: clean
	rm -f .depend

install:

dist: $(ALL) Makefile
	install -d $(DISTPATH)/syscallmgr
	install -m 0644 $(ALL) Makefile $(DISTPATH)/syscallmgr

depend dep: $(CFILES) $(HFILES)
	$(CPP) -MM $(CFLAGS) $(CFILES) $(INCDIR) -I$(USRSRCDIR) > .depend

dummy:

#
# include a dependency file if one exists
#
ifeq (.depend,$(wildcard .depend))
include .depend
endif
