#!/usr/bin/python3

import os
import shutil
import subprocess
import sys

TOSEC_IBM_PC_MIRROR    = 'https://archive.org/download/IBM_PC_Compatibles_TOSEC_2012_04_23/IBM_PC_Compatibles_TOSEC_2012_04_23.zip'
OPENLINUX_MIRROR       = 'ftp://ftp.nvg.org/pub/mirrors/metalab.unc.edu/distributions/caldera'

MSDOS622_URL = TOSEC_IBM_PC_MIRROR + '/IBM%20PC%20Compatibles%20%5BTOSEC%5D%2FIBM%20PC%20Compatibles%20-%20Operating%20Systems%20-%20%5BIMA%5D%20%28TOSEC-v2011-01-06_CM%29%2FMicrosoft%20MS-DOS%20v6.22%20%281994%29%28Microsoft%29%28Disk%201%20of%203%29.zip'
OPENDOS702RPM_URL = OPENLINUX_MIRROR + '/updates/OpenLinux/1.3/current/SRPMS/opendos-hdimage-7.02-4.src.rpm'
OPENDOS702RPM_SHA512SUM = '174f7c12e07c301189a59a53ba99912a8c3f2579319984cc2a26d25a4e9b27a6227e8b18516c88525794cd260112528f7e6957c5438be6e9a345c9dcbb01ef27'

THIRD_PARTY_DOS_CHOICES = (
    ('Microsoft MS-DOS v6.22 (1994)', MSDOS622_URL),
    ('Caldera OpenDOS 7.02 (1997)'  , OPENDOS702RPM_URL, OPENDOS702RPM_SHA512SUM)
    )

SCRIPT_ROOT = os.path.dirname(os.path.abspath(__file__)) + '/../share/dosemu/libexec' if "src/bindist" not in __file__ else os.path.dirname(os.path.abspath(__file__))

doschoices = []
completed_process = subprocess.run([SCRIPT_ROOT + '/dosemu-downloaddos', '-l'], stdout=subprocess.PIPE)
if (completed_process.returncode != 0):
    sys.exit(completed_process.returncode)
print('DOSEMU2 DOS installer script\n\nPick the DOS to install:')
for dosline in completed_process.stdout.decode(sys.stdout.encoding).splitlines():
    dos = dosline.split(' ', 1)
    print(str(len(doschoices) + 1) + '. ' + dos[1])
    doschoices.append(['-d', dos[0]])
for dos_choice in THIRD_PARTY_DOS_CHOICES:
    print(str(len(doschoices) + 1) + '. ' + dos_choice[0])
    doschoices.append(['-c', dos_choice[1], dos_choice[2] if len(dos_choice) >= 3 else None])
print('0. Quit')

choice = ''
while not choice.isdigit() or int(choice) > len(doschoices):
    choice = input('[0-' + str(len(doschoices)) + '] ')

if int(choice) <= 0:
    print('Quitting... no DOS was installed.')
    sys.exit()

tmp_dir = '/tmp/' + os.path.basename(sys.argv[0]) + '-' + os.environ['USER'] + '-' + str(os.getpid())

if len(doschoices[int(choice) - 1]) >= 3 and doschoices[int(choice) - 1][2]:
    download_command = [SCRIPT_ROOT + '/dosemu-downloaddos',
                        doschoices[int(choice) - 1][0],
                        doschoices[int(choice) - 1][1],
                        tmp_dir,
                        '-s',
                        doschoices[int(choice) - 1][2]]
else:
    download_command = [SCRIPT_ROOT + '/dosemu-downloaddos',
                        doschoices[int(choice) - 1][0],
                        doschoices[int(choice) - 1][1],
                        tmp_dir]

if (subprocess.run(download_command).returncode == 0):
    subprocess.run([SCRIPT_ROOT + '/dosemu-installdos', tmp_dir, os.environ['HOME'] + '/.dosemu/drive_c'])
    shutil.rmtree(tmp_dir)
