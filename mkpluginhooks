#! /bin/bash

HEADERS="init close inte6 ioselect poll"

PLUG=plugin
DIR=src/$PLUG
INC=src/include
PREF=plugin_
CONF=config
LIB=plugin_libdirs

function gendummy {
  for i in $HEADERS; do
    if [ "$1" = "clean" ]; then
      rm -f $INC/$PREF$i.h
    else
      echo -n "" >$INC/$PREF$i.h
    fi
  done
}


gendummy clean
rm -f $LIB
if [ "$1" = "clean" ]; then
  exit 0
fi

gendummy

if [ ! -d $DIR ]; then
  exit 1
fi

PDIRS=`cd $DIR; find ./ -maxdepth 1 -type d -printf ' %f'`

if [ "$PDIRS" != " " ]; then
  rm -f $LIB
  for d in $PDIRS; do
    if [ -f $DIR/$d/$CONF/${PREF}enable ]; then
      enable=`cat $DIR/$d/$CONF/${PREF}enable`
    else
      enable=no
    fi
    if [ "$enable" = "yes" ]; then
      if [ -f $DIR/$d/$CONF/${PREF}dirs ]; then
        for i in `cat $DIR/$d/$CONF/${PREF}dirs`; do
          if [ "$i" = "./" ]; then
            echo -n " $PLUG/$d" >>$LIB
          else
            echo -n " $PLUG/$d/$i" >>$LIB
          fi
        done
      else
        echo -n " $PLUG/$d" >>$LIB
      fi
      for h in $HEADERS; do
        if [ -f $DIR/$d/$CONF/$PREF$h.h ]; then
          echo -E "#include \"../$PLUG/$d/$CONF/$PREF$h.h\"" >>$INC/$PREF$h.h
        fi
      done
    fi
  done
  if [ -f $LIB ]; then
    echo "" >>$LIB
  fi
fi
